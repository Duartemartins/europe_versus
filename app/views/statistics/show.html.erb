<% 
  # Define countries array using official EU classifications
  key_countries = [
    # Eurozone countries (20 countries using the Euro)
    { key: 'germany', flag: 'üá©üá™', name: 'Germany', category: 'eurozone' },
    { key: 'france', flag: 'üá´üá∑', name: 'France', category: 'eurozone' },
    { key: 'italy', flag: 'üáÆüáπ', name: 'Italy', category: 'eurozone' },
    { key: 'spain', flag: 'üá™üá∏', name: 'Spain', category: 'eurozone' },
    { key: 'netherlands', flag: 'üá≥üá±', name: 'Netherlands', category: 'eurozone' },
    { key: 'belgium', flag: 'üáßüá™', name: 'Belgium', category: 'eurozone' },
    { key: 'austria', flag: 'üá¶üáπ', name: 'Austria', category: 'eurozone' },
    { key: 'ireland', flag: 'üáÆüá™', name: 'Ireland', category: 'eurozone' },
    { key: 'portugal', flag: 'üáµüáπ', name: 'Portugal', category: 'eurozone' },
    { key: 'greece', flag: 'üá¨üá∑', name: 'Greece', category: 'eurozone' },
    { key: 'finland', flag: 'üá´üáÆ', name: 'Finland', category: 'eurozone' },
    { key: 'slovakia', flag: 'üá∏üá∞', name: 'Slovakia', category: 'eurozone' },
    { key: 'slovenia', flag: 'üá∏üáÆ', name: 'Slovenia', category: 'eurozone' },
    { key: 'estonia', flag: 'üá™üá™', name: 'Estonia', category: 'eurozone' },
    { key: 'latvia', flag: 'üá±üáª', name: 'Latvia', category: 'eurozone' },
    { key: 'lithuania', flag: 'üá±üáπ', name: 'Lithuania', category: 'eurozone' },
    { key: 'luxembourg', flag: 'üá±üá∫', name: 'Luxembourg', category: 'eurozone' },
    { key: 'malta', flag: 'üá≤üáπ', name: 'Malta', category: 'eurozone' },
    { key: 'cyprus', flag: 'üá®üáæ', name: 'Cyprus', category: 'eurozone' },
    { key: 'croatia', flag: 'üá≠üá∑', name: 'Croatia', category: 'eurozone' },
    # Non-Euro EU members (7 EU countries not using the Euro)
    { key: 'poland', flag: 'üáµüá±', name: 'Poland', category: 'non-euro-eu' },
    { key: 'sweden', flag: 'üá∏üá™', name: 'Sweden', category: 'non-euro-eu' },
    { key: 'denmark', flag: 'üá©üá∞', name: 'Denmark', category: 'non-euro-eu' },
    { key: 'czech_republic', flag: 'üá®üáø', name: 'Czechia', category: 'non-euro-eu' },
    { key: 'hungary', flag: 'üá≠üá∫', name: 'Hungary', category: 'non-euro-eu' },
    { key: 'romania', flag: 'üá∑üá¥', name: 'Romania', category: 'non-euro-eu' },
    { key: 'bulgaria', flag: 'üáßüá¨', name: 'Bulgaria', category: 'non-euro-eu' },
    # Non-EU European countries
    { key: 'switzerland', flag: 'üá®üá≠', name: 'Switzerland', category: 'non-eu' },
    { key: 'norway', flag: 'üá≥üá¥', name: 'Norway', category: 'non-eu' },
    { key: 'united_kingdom', flag: 'üá¨üáß', name: 'UK', category: 'non-eu' },
    { key: 'iceland', flag: 'üáÆüá∏', name: 'Iceland', category: 'non-eu' },
    # Regional aggregates
    { key: 'europe', flag: 'üá™üá∫', name: 'Europe', category: 'aggregates' },
    { key: 'european_union', flag: 'üá™üá∫', name: 'European Union', category: 'aggregates' },
    # Global comparisons
    { key: 'usa', flag: 'üá∫üá∏', name: 'USA', category: 'global' },
    { key: 'china', flag: 'üá®üá≥', name: 'China', category: 'global' },
    { key: 'india', flag: 'üáÆüá≥', name: 'India', category: 'global' }
  ]
%>

<div class="max-w-7xl mx-auto px-6">
  <!-- Navigation -->
  <div class="py-8 border-b-2 border-black">
    <%= link_to statistics_path, class: "inline-flex items-center font-mono text-sm uppercase tracking-brutal hover:text-[#0066FF] transition-colors group" do %>
      <svg class="w-4 h-4 mr-3 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      ‚Üê Back to Statistics
    <% end %>
  </div>
  
  <!-- Header -->
  <div class="py-16 border-b-2 border-black">
    <div class="flex items-center gap-4 mb-8">
      <% if @statistic&.year %>
        <span class="font-mono text-xs uppercase tracking-brutal bg-black text-white px-3 py-1">
          <%= @statistic.year %>
        </span>
      <% end %>
      <span class="font-mono text-xs uppercase tracking-brutal text-black/50">
        Statistics
      </span>
    </div>
    <h1 class="text-5xl md:text-7xl font-black tracking-tighter mb-8 uppercase"><%= @statistic&.metric || @chart_name&.humanize %></h1>
    
    <% if @statistic&.description.present? %>
      <div class="border-l-2 border-[#0066FF] pl-6 max-w-2xl">
        <p class="text-lg text-black/70 leading-relaxed"><%= @statistic.description %></p>
      </div>
    <% end %>
  </div>

  <!-- Interactive Chart -->
  <% if @chart_data && @chart_data[:years]&.any? %>
    <%= render 'shared/chart', 
        chart_data: @chart_data,
        title: @statistic&.metric || @chart_name&.humanize,
        unit: @chart_data.dig(:metadata, :unit) || @statistic&.unit,
        metric_name: @metric_name,
        source: @statistic&.source || @chart_data&.dig(:metadata, :source) %>
  <% end %>

  <!-- Regional Comparison Cards -->
  <div class="py-12 border-b-2 border-black">
    <h2 class="font-mono text-sm uppercase tracking-brutal mb-8">Regional Comparison</h2>
    <div class="grid grid-cols-2 md:grid-cols-5 gap-0">
      <% 
        comparison_regions = [
          { key: 'europe', flag: 'üá™üá∫', name: 'Europe', highlight: true },
          { key: 'european_union', flag: 'üá™üá∫', name: 'EU-27', highlight: false },
          { key: 'usa', flag: 'üá∫üá∏', name: 'USA', highlight: false },
          { key: 'india', flag: 'üáÆüá≥', name: 'India', highlight: false },
          { key: 'china', flag: 'üá®üá≥', name: 'China', highlight: false }
        ]
        latest_year = @chart_data[:years]&.max if @chart_data
      %>
      <% comparison_regions.each_with_index do |region, index| %>
        <% 
          # For Europe, fallback to european_union data if europe data is missing or empty
          if region[:key] == 'europe'
            europe_data = @chart_data.dig(:countries, 'europe', :data) || {}
            eu_data = @chart_data.dig(:countries, 'european_union', :data) || {}
            country_data = europe_data.any? ? europe_data : eu_data
          else
            country_data = @chart_data.dig(:countries, region[:key], :data) || {}
          end
          latest_country_year = country_data.keys.max
          value = latest_country_year ? country_data[latest_country_year] : nil
        %>
        <div class="border-2 border-black p-6 <%= index > 0 ? 'border-l-0' : '' %> <%= region[:highlight] ? 'bg-[#0066FF] text-white' : '' %>">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-2xl"><%= region[:flag] %></span>
            <div>
              <div class="font-mono text-sm font-bold"><%= region[:name] %></div>
              <div class="font-mono text-xs <%= region[:highlight] ? 'text-white/60' : 'text-black/50' %>"><%= latest_country_year || '‚Äî' %></div>
            </div>
          </div>
          <div class="font-mono text-2xl md:text-3xl font-bold">
            <% if value %>
              <%= format_value_with_unit(value, @chart_data&.dig(:metadata, :unit) || @statistic&.unit, decimals: 2) %>
            <% else %>
              <span class="<%= region[:highlight] ? 'text-white/50' : 'text-black/30' %>">‚Äî</span>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Historical Data Table with Filters -->
  <div class="py-12 border-b-2 border-black">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8 pb-4 border-b border-black">
      <h2 class="font-mono text-sm uppercase tracking-brutal mb-4 lg:mb-0">Historical Data</h2>
      
      <!-- Filter Controls -->
      <div class="flex flex-wrap gap-2">
        <button data-filter="all" class="filter-btn active font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-black text-white hover:bg-[#0066FF] hover:border-[#0066FF] transition-colors">
          All
        </button>
        <button data-filter="eu-27" class="filter-btn font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors">
          EU-27
        </button>
        <button data-filter="eurozone" class="filter-btn font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors">
          Eurozone
        </button>
        <button data-filter="non-euro-eu" class="filter-btn font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors">
          Non-‚Ç¨ EU
        </button>
        <button data-filter="non-eu" class="filter-btn font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors">
          Non-EU
        </button>
        <button data-filter="global" class="filter-btn font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors">
          Global
        </button>
        <button data-filter="aggregates" class="filter-btn font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors">
          Aggregates
        </button>
      </div>
    </div>
    
    <% if @chart_data && @chart_data[:years]&.any? %>
      <div class="overflow-x-auto border-2 border-black">
        <table class="w-full">
          <thead>
            <tr class="border-b-2 border-black bg-[#F5F5F5]">
              <th class="sticky left-0 z-10 bg-[#F5F5F5] text-left py-3 px-4 font-mono text-xs uppercase tracking-brutal border-r-2 border-black">Year</th>
              <% key_countries.each do |country| %>
                <th class="country-column text-right py-3 px-4 font-mono text-xs uppercase tracking-brutal whitespace-nowrap" 
                    data-category="<%= country[:category] %>" 
                    data-country="<%= country[:key] %>">
                  <%= country[:flag] %> <%= country[:name] %>
                </th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% @chart_data[:years].sort.reverse.first(15).each_with_index do |year, row_idx| %>
              <tr class="border-b border-black/20 hover:bg-[#F5F5F5] transition-colors">
                <td class="sticky left-0 z-10 bg-white py-3 px-4 font-mono text-sm font-bold border-r-2 border-black"><%= year %></td>
                <% key_countries.each do |country| %>
                  <% value = @chart_data.dig(:countries, country[:key], :data, year) %>
                  <td class="country-column py-3 px-4 text-right font-mono text-sm" 
                      data-category="<%= country[:category] %>" 
                      data-country="<%= country[:key] %>">
                    <% if value %>
                      <span class="<%= country[:category] == 'aggregates' || country[:key] == 'europe' ? 'text-[#0066FF] font-bold' : '' %>">
                        <%= format_value_with_unit(value, @chart_data&.dig(:metadata, :unit) || @statistic&.unit, decimals: 1) %>
                      </span>
                    <% else %>
                      <span class="text-black/30">‚Äî</span>
                    <% end %>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <% if @chart_data[:years].length > 15 %>
        <div class="mt-4 font-mono text-xs text-black/50 text-center">
          Showing latest 15 years. Total data spans <%= @chart_data[:years].length %> years 
          (<%= @chart_data[:years].min %> ‚Äì <%= @chart_data[:years].max %>)
        </div>
      <% end %>
    <% end %>
  </div>

  <!-- Comparison Bars -->
  <div class="py-12 border-b-2 border-black">
    <h2 class="font-mono text-sm uppercase tracking-brutal mb-8 pb-4 border-b border-black">Visual Comparison</h2>
    
    <% 
      # Get values from chart data for comparison bars
      latest_year = @chart_data[:years]&.max if @chart_data
      bar_regions = [
        { key: 'europe', flag: 'üá™üá∫', name: 'Europe', color: 'bg-[#0066FF]', highlight: true },
        { key: 'usa', flag: 'üá∫üá∏', name: 'USA', color: 'bg-black' },
        { key: 'india', flag: 'üáÆüá≥', name: 'India', color: 'bg-black/70' },
        { key: 'china', flag: 'üá®üá≥', name: 'China', color: 'bg-black/50' }
      ]
      bar_values = bar_regions.map { |r| 
        val = @chart_data&.dig(:countries, r[:key], :data, latest_year)
        { **r, value: val }
      }.select { |r| r[:value].present? }
      max_value = bar_values.map { |r| r[:value] }.max || 1
    %>
    
    <div class="space-y-6">
      <% bar_values.each do |region| %>
        <div class="group">
          <div class="flex items-center justify-between mb-3">
            <span class="font-mono text-sm uppercase tracking-brutal <%= region[:highlight] ? 'font-bold' : '' %>">
              <%= region[:flag] %> <%= region[:name] %>
            </span>
            <span class="font-mono text-lg font-bold <%= region[:highlight] ? 'text-[#0066FF]' : '' %>">
              <%= format_value_with_unit(region[:value], @chart_data&.dig(:metadata, :unit) || @statistic&.unit, decimals: 2) %>
            </span>
          </div>
          <div class="w-full h-10 bg-[#F5F5F5] border-2 border-black">
            <% percentage = (region[:value] / max_value * 100).round(1) %>
            <div class="<%= region[:color] %> h-full transition-all duration-700 flex items-center justify-end pr-4" 
                 style="width: <%= percentage %>%">
              <% if percentage > 15 %>
                <span class="font-mono text-xs text-white font-bold"><%= percentage %>%</span>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Key Insights -->
  <% if @statistic %>
  <div class="py-12 border-b-2 border-black">
    <h3 class="font-mono text-sm uppercase tracking-brutal mb-8 pb-4 border-b border-black">Key Insights</h3>
    
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-0">
      <% if @statistic.europe_value && @statistic.us_value && @statistic.us_value != 0 %>
        <div class="border-2 border-black p-6">
          <div class="font-mono text-xs uppercase tracking-brutal text-black/50 mb-4">EUR vs USA</div>
          <% diff_us = ((@statistic.europe_value - @statistic.us_value) / @statistic.us_value * 100).round(1) %>
          <div class="font-mono text-3xl md:text-4xl font-bold <%= diff_us >= 0 ? 'text-[#0066FF]' : 'text-black' %>">
            <%= diff_us >= 0 ? '+' : '' %><%= diff_us %>%
          </div>
        </div>
      <% end %>
      
      <% if @statistic.europe_value && @statistic.india_value && @statistic.india_value != 0 %>
        <div class="border-2 border-black border-l-0 p-6">
          <div class="font-mono text-xs uppercase tracking-brutal text-black/50 mb-4">EUR vs IND</div>
          <% diff_india = ((@statistic.europe_value - @statistic.india_value) / @statistic.india_value * 100).round(1) %>
          <div class="font-mono text-3xl md:text-4xl font-bold <%= diff_india >= 0 ? 'text-[#0066FF]' : 'text-black' %>">
            <%= diff_india >= 0 ? '+' : '' %><%= diff_india %>%
          </div>
        </div>
      <% end %>
      
      <% if @statistic.europe_value && @statistic.china_value && @statistic.china_value != 0 %>
        <div class="border-2 border-black border-l-0 p-6">
          <div class="font-mono text-xs uppercase tracking-brutal text-black/50 mb-4">EUR vs CHN</div>
          <% diff_china = ((@statistic.europe_value - @statistic.china_value) / @statistic.china_value * 100).round(1) %>
          <div class="font-mono text-3xl md:text-4xl font-bold <%= diff_china >= 0 ? 'text-[#0066FF]' : 'text-black' %>">
            <%= diff_china >= 0 ? '+' : '' %><%= diff_china %>%
          </div>
        </div>
      <% end %>
      
      <% 
        values = { 'EU' => @statistic.europe_value, 'USA' => @statistic.us_value, 'IND' => @statistic.india_value, 'CHN' => @statistic.china_value }.compact
        if values.any?
          best = values.max_by { |k, v| v }.first
      %>
        <div class="border-2 border-black border-l-0 p-6">
          <div class="font-mono text-xs uppercase tracking-brutal text-black/50 mb-4">Best Performer</div>
          <div class="font-mono text-3xl md:text-4xl font-bold <%= best == 'EU' ? 'text-[#0066FF]' : 'text-black' %>"><%= best %></div>
        </div>
      <% end %>
    </div>
  </div>
  <% end %>

  <!-- Europe Calculation Methodology -->
  <div class="py-12 border-b-2 border-black">
    <%= render 'shared/europe_calculation_methodology', compact_view: true %>
  </div>

  <!-- Source -->
  <div class="py-8">
    <div class="flex items-center gap-4">
      <span class="font-mono text-xs uppercase tracking-brutal text-black/50">Source</span>
      <div class="flex-1 h-px bg-black/10"></div>
      <span class="font-mono text-sm"><%= @statistic&.source || @chart_data&.dig(:metadata, :source) || 'Our World in Data' %></span>
    </div>
  </div>
</div>

<!-- Country Filter JavaScript -->
<script>
document.addEventListener('turbo:load', initializeFilters);
document.addEventListener('DOMContentLoaded', initializeFilters);

function initializeFilters() {
  const filterButtons = document.querySelectorAll('.filter-btn');
  const countryColumns = document.querySelectorAll('.country-column');
  
  if (!filterButtons.length) return;
  
  filterButtons.forEach(button => {
    button.addEventListener('click', function() {
      const filter = this.dataset.filter;
      
      // Update button states
      filterButtons.forEach(btn => {
        btn.classList.remove('active', 'bg-black', 'text-white');
        btn.classList.add('bg-white');
      });
      this.classList.add('active', 'bg-black', 'text-white');
      this.classList.remove('bg-white');
      
      // Filter columns - EU-27 includes both eurozone and non-euro-eu
      countryColumns.forEach(column => {
        const category = column.dataset.category;
        let shouldShow = false;
        
        if (filter === 'all') {
          shouldShow = true;
        } else if (filter === 'eu-27') {
          // EU-27 = Eurozone + Non-Euro EU members
          shouldShow = (category === 'eurozone' || category === 'non-euro-eu');
        } else {
          shouldShow = (category === filter);
        }
        
        column.style.display = shouldShow ? '' : 'none';
      });
    });
  });
}
</script>
