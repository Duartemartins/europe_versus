<%# Interactive Chart Component %>

<% 
  chart_data ||= {}
  title ||= chart_data.dig(:metadata, :title) || 'Data Trend'
  unit ||= chart_data.dig(:metadata, :unit) || ''
  metric_name ||= 'chart'
  source ||= chart_data.dig(:metadata, :source) || 'Our World in Data'
  
  # Available countries from data
  available_countries = chart_data[:countries]&.keys || []
  years = chart_data[:years]&.sort || []
  
  # Official country groupings - using proper EU/EEA/Eurozone classifications
  country_groups = {
    'Aggregates' => [
      { key: 'europe', flag: 'ðŸ‡ªðŸ‡º', name: 'Europe', category: 'aggregates' },
      { key: 'european_union', flag: 'ðŸ‡ªðŸ‡º', name: 'EU-27', category: 'aggregates' },
      { key: 'eurozone', flag: 'ðŸ’¶', name: 'Eurozone', category: 'aggregates' },
      { key: 'non_euro_eu', flag: 'ðŸ‡ªðŸ‡º', name: 'Non-â‚¬ EU', category: 'aggregates' },
      { key: 'non_eu_europe', flag: 'ðŸŒ', name: 'Non-EU Europe', category: 'aggregates' }
    ],
    'Global' => [
      { key: 'usa', flag: 'ðŸ‡ºðŸ‡¸', name: 'USA', category: 'global' },
      { key: 'china', flag: 'ðŸ‡¨ðŸ‡³', name: 'China', category: 'global' },
      { key: 'india', flag: 'ðŸ‡®ðŸ‡³', name: 'India', category: 'global' }
    ],
    'Eurozone' => [
      # The 20 countries using the Euro (as of 2024)
      { key: 'germany', flag: 'ðŸ‡©ðŸ‡ª', name: 'Germany', category: 'eurozone' },
      { key: 'france', flag: 'ðŸ‡«ðŸ‡·', name: 'France', category: 'eurozone' },
      { key: 'italy', flag: 'ðŸ‡®ðŸ‡¹', name: 'Italy', category: 'eurozone' },
      { key: 'spain', flag: 'ðŸ‡ªðŸ‡¸', name: 'Spain', category: 'eurozone' },
      { key: 'netherlands', flag: 'ðŸ‡³ðŸ‡±', name: 'Netherlands', category: 'eurozone' },
      { key: 'belgium', flag: 'ðŸ‡§ðŸ‡ª', name: 'Belgium', category: 'eurozone' },
      { key: 'austria', flag: 'ðŸ‡¦ðŸ‡¹', name: 'Austria', category: 'eurozone' },
      { key: 'ireland', flag: 'ðŸ‡®ðŸ‡ª', name: 'Ireland', category: 'eurozone' },
      { key: 'portugal', flag: 'ðŸ‡µðŸ‡¹', name: 'Portugal', category: 'eurozone' },
      { key: 'greece', flag: 'ðŸ‡¬ðŸ‡·', name: 'Greece', category: 'eurozone' },
      { key: 'finland', flag: 'ðŸ‡«ðŸ‡®', name: 'Finland', category: 'eurozone' },
      { key: 'slovakia', flag: 'ðŸ‡¸ðŸ‡°', name: 'Slovakia', category: 'eurozone' },
      { key: 'slovenia', flag: 'ðŸ‡¸ðŸ‡®', name: 'Slovenia', category: 'eurozone' },
      { key: 'estonia', flag: 'ðŸ‡ªðŸ‡ª', name: 'Estonia', category: 'eurozone' },
      { key: 'latvia', flag: 'ðŸ‡±ðŸ‡»', name: 'Latvia', category: 'eurozone' },
      { key: 'lithuania', flag: 'ðŸ‡±ðŸ‡¹', name: 'Lithuania', category: 'eurozone' },
      { key: 'luxembourg', flag: 'ðŸ‡±ðŸ‡º', name: 'Luxembourg', category: 'eurozone' },
      { key: 'malta', flag: 'ðŸ‡²ðŸ‡¹', name: 'Malta', category: 'eurozone' },
      { key: 'cyprus', flag: 'ðŸ‡¨ðŸ‡¾', name: 'Cyprus', category: 'eurozone' },
      { key: 'croatia', flag: 'ðŸ‡­ðŸ‡·', name: 'Croatia', category: 'eurozone' }
    ],
    'Non-Euro EU' => [
      # EU members not using the Euro
      { key: 'poland', flag: 'ðŸ‡µðŸ‡±', name: 'Poland', category: 'non-euro-eu' },
      { key: 'sweden', flag: 'ðŸ‡¸ðŸ‡ª', name: 'Sweden', category: 'non-euro-eu' },
      { key: 'denmark', flag: 'ðŸ‡©ðŸ‡°', name: 'Denmark', category: 'non-euro-eu' },
      { key: 'czechia', flag: 'ðŸ‡¨ðŸ‡¿', name: 'Czechia', category: 'non-euro-eu' },
      { key: 'czech_republic', flag: 'ðŸ‡¨ðŸ‡¿', name: 'Czechia', category: 'non-euro-eu' },
      { key: 'hungary', flag: 'ðŸ‡­ðŸ‡º', name: 'Hungary', category: 'non-euro-eu' },
      { key: 'romania', flag: 'ðŸ‡·ðŸ‡´', name: 'Romania', category: 'non-euro-eu' },
      { key: 'bulgaria', flag: 'ðŸ‡§ðŸ‡¬', name: 'Bulgaria', category: 'non-euro-eu' }
    ],
    'Non-EU Europe' => [
      # European countries not in the EU (includes EEA, EFTA, Balkans, Eastern Europe, and small states)
      { key: 'united_kingdom', flag: 'ðŸ‡¬ðŸ‡§', name: 'UK', category: 'non-eu' },
      { key: 'switzerland', flag: 'ðŸ‡¨ðŸ‡­', name: 'Switzerland', category: 'non-eu' },
      { key: 'norway', flag: 'ðŸ‡³ðŸ‡´', name: 'Norway', category: 'non-eu' },
      { key: 'iceland', flag: 'ðŸ‡®ðŸ‡¸', name: 'Iceland', category: 'non-eu' },
      # Eastern Europe
      { key: 'ukraine', flag: 'ðŸ‡ºðŸ‡¦', name: 'Ukraine', category: 'non-eu' },
      { key: 'belarus', flag: 'ðŸ‡§ðŸ‡¾', name: 'Belarus', category: 'non-eu' },
      { key: 'moldova', flag: 'ðŸ‡²ðŸ‡©', name: 'Moldova', category: 'non-eu' },
      { key: 'russia', flag: 'ðŸ‡·ðŸ‡º', name: 'Russia', category: 'non-eu' },
      # Balkans (non-EU)
      { key: 'albania', flag: 'ðŸ‡¦ðŸ‡±', name: 'Albania', category: 'non-eu' },
      { key: 'bosnia_herzegovina', flag: 'ðŸ‡§ðŸ‡¦', name: 'Bosnia & Herzegovina', category: 'non-eu' },
      { key: 'serbia', flag: 'ðŸ‡·ðŸ‡¸', name: 'Serbia', category: 'non-eu' },
      { key: 'montenegro', flag: 'ðŸ‡²ðŸ‡ª', name: 'Montenegro', category: 'non-eu' },
      { key: 'north_macedonia', flag: 'ðŸ‡²ðŸ‡°', name: 'North Macedonia', category: 'non-eu' },
      { key: 'kosovo', flag: 'ðŸ‡½ðŸ‡°', name: 'Kosovo', category: 'non-eu' },
      # Caucasus
      { key: 'armenia', flag: 'ðŸ‡¦ðŸ‡²', name: 'Armenia', category: 'non-eu' },
      { key: 'azerbaijan', flag: 'ðŸ‡¦ðŸ‡¿', name: 'Azerbaijan', category: 'non-eu' },
      { key: 'georgia', flag: 'ðŸ‡¬ðŸ‡ª', name: 'Georgia', category: 'non-eu' },
      # Transcontinental
      { key: 'turkey', flag: 'ðŸ‡¹ðŸ‡·', name: 'Turkey', category: 'non-eu' },
      # Small states
      { key: 'andorra', flag: 'ðŸ‡¦ðŸ‡©', name: 'Andorra', category: 'non-eu' },
      { key: 'monaco', flag: 'ðŸ‡²ðŸ‡¨', name: 'Monaco', category: 'non-eu' },
      { key: 'san_marino', flag: 'ðŸ‡¸ðŸ‡²', name: 'San Marino', category: 'non-eu' },
      { key: 'vatican', flag: 'ðŸ‡»ðŸ‡¦', name: 'Vatican', category: 'non-eu' },
      { key: 'liechtenstein', flag: 'ðŸ‡±ðŸ‡®', name: 'Liechtenstein', category: 'non-eu' }
    ]
  }
  
  # Filter country groups to only show countries with data
  filtered_groups = country_groups.transform_values do |countries|
    countries.select { |c| available_countries.include?(c[:key]) }
  end.reject { |_, countries| countries.empty? }
  
  # Count total available countries
  total_countries = filtered_groups.values.flatten.size
%>

<div class="py-12 border-b-2 border-black" 
     data-controller="chart"
     data-chart-data-value="<%= chart_data.to_json %>"
     data-chart-title-value="<%= title %>"
     data-chart-unit-value="<%= unit %>"
     data-chart-metric-name-value="<%= metric_name %>">
  
  <!-- Chart Header -->
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
    <h2 class="font-mono text-sm uppercase tracking-brutal">Interactive Trend</h2>
    
    <!-- Export Buttons -->
    <div class="flex gap-2">
      <button data-chart-target="exportBtn" 
              data-action="click->chart#exportImage"
              class="font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
        </svg>
        Download PNG
      </button>
      <button data-action="click->chart#copyToClipboard"
              class="font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
        </svg>
        Copy
      </button>
    </div>
  </div>

  <!-- Chart Container (for export) -->
  <div data-chart-target="container" class="border-2 border-black bg-white">
    <!-- Chart Title Bar -->
    <div class="border-b-2 border-black px-6 py-4 bg-[#F5F5F5]">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-mono text-lg font-bold uppercase"><%= title %></h3>
          <p class="font-mono text-xs text-black/60 mt-1">Source: EuropeVersus.com â€¢ <%= source %></p>
        </div>
        <div class="font-mono text-xs text-black/60">
          europeversus.com
        </div>
      </div>
    </div>
    
    <!-- Chart Canvas -->
    <div class="p-6">
      <div class="relative" style="height: 400px;">
        <canvas data-chart-target="canvas"></canvas>
      </div>
      
      <!-- Custom Legend -->
      <div data-chart-target="legend" class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-black/20">
        <!-- Populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Controls Panel -->
  <div class="mt-6 border-2 border-black bg-white">
    <!-- Mode Toggle -->
    <div class="border-b-2 border-black px-6 py-4">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <span class="font-mono text-xs uppercase tracking-brutal font-bold">Display Mode</span>
        <div class="flex">
          <button data-chart-target="modeToggle"
                  data-mode="absolute"
                  data-action="click->chart#toggleMode"
                  class="font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black border-r-0 bg-black text-white hover:bg-[#0066FF] hover:border-[#0066FF] transition-colors">
            Absolute Values
          </button>
          <button data-chart-target="modeToggle"
                  data-mode="relative"
                  data-action="click->chart#toggleMode"
                  class="font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors">
            % Change from Start
          </button>
        </div>
      </div>
    </div>

    <!-- Year Range -->
    <div class="border-b-2 border-black px-6 py-4">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <span class="font-mono text-xs uppercase tracking-brutal font-bold">Year Range</span>
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2">
            <label class="font-mono text-xs text-black/60">From</label>
            <select data-chart-target="yearStart" 
                    data-action="change->chart#updateYearRange"
                    class="font-mono text-sm border-2 border-black px-3 py-1.5 bg-white">
              <% years.each do |year| %>
                <option value="<%= year %>" <%= year == years.first ? 'selected' : '' %>><%= year %></option>
              <% end %>
            </select>
          </div>
          <span class="font-mono text-black/40">â†’</span>
          <div class="flex items-center gap-2">
            <label class="font-mono text-xs text-black/60">To</label>
            <select data-chart-target="yearEnd" 
                    data-action="change->chart#updateYearRange"
                    class="font-mono text-sm border-2 border-black px-3 py-1.5 bg-white">
              <% years.each do |year| %>
                <option value="<%= year %>" <%= year == years.last ? 'selected' : '' %>><%= year %></option>
              <% end %>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Filter Controls - Official EU groupings -->
    <div class="border-b-2 border-black px-6 py-4">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <span class="font-mono text-xs uppercase tracking-brutal font-bold">Filter</span>
        <div class="flex flex-wrap gap-2">
          <button data-group="all" 
                  data-action="click->chart#selectRegionGroup"
                  class="font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors">
            All
          </button>
          <button data-group="eu-27" 
                  data-action="click->chart#selectRegionGroup"
                  class="font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors">
            EU-27
          </button>
          <button data-group="eurozone" 
                  data-action="click->chart#selectRegionGroup"
                  class="font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors">
            Eurozone
          </button>
          <button data-group="non-euro-eu" 
                  data-action="click->chart#selectRegionGroup"
                  class="font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors">
            Non-â‚¬ EU
          </button>
          <button data-group="non-eu" 
                  data-action="click->chart#selectRegionGroup"
                  class="font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors">
            Non-EU
          </button>
          <button data-group="global" 
                  data-action="click->chart#selectRegionGroup"
                  class="font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors">
            Global
          </button>
          <button data-group="aggregates" 
                  data-action="click->chart#selectRegionGroup"
                  class="font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors">
            Aggregates
          </button>
          <button data-group="clear" 
                  data-action="click->chart#selectRegionGroup"
                  class="font-mono text-xs uppercase tracking-brutal px-4 py-2 border-2 border-black bg-white hover:bg-black hover:text-white transition-colors text-red-600">
            Clear
          </button>
        </div>
      </div>
    </div>

    <!-- Country Selection - Collapsible Dropdown -->
    <div class="px-6 py-4">
      <details class="group">
        <summary class="flex items-center justify-between cursor-pointer list-none">
          <div class="flex items-center gap-3">
            <span class="font-mono text-xs uppercase tracking-brutal font-bold">Select Countries/Regions</span>
            <span data-chart-target="selectionCount" class="font-mono text-xs bg-[#0066FF] text-white px-2 py-0.5">4 selected</span>
          </div>
          <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </summary>
        
        <div class="mt-4 pt-4 border-t border-black/20">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
            <% filtered_groups.each do |group_name, countries| %>
              <div>
                <h4 class="font-mono text-xs uppercase tracking-brutal text-black/60 mb-3 pb-2 border-b border-black/20"><%= group_name %></h4>
                <div class="space-y-1">
                  <% countries.each do |country| %>
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-[#F5F5F5] px-2 py-1 -mx-2 transition-colors">
                      <input type="checkbox" 
                             data-chart-target="countryCheckbox"
                             data-country="<%= country[:key] %>"
                             data-category="<%= country[:category] %>"
                             data-action="change->chart#toggleCountry"
                             class="w-4 h-4 border-2 border-black accent-[#0066FF]"
                             <%= ['europe', 'usa', 'china', 'india'].include?(country[:key]) ? 'checked' : '' %>>
                      <span class="text-base"><%= country[:flag] %></span>
                      <span class="font-mono text-xs"><%= country[:name] %></span>
                    </label>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </details>
    </div>
  </div>
</div>
